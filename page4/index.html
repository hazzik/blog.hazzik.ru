<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="description" content="" />
  <meta name='yandex-verification' content='7254b866679e5872' />

  <title>
    
      Hazzik's blog &middot; 
    
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="tag-cloud">
      <a href="/tag/dot-net" class="set-4">.NET</a> <a href="/tag/dot-net-3-dot-5" class="set-1">.NET 3.5</a> <a href="/tag/dot-netconf" class="set-1">.netconf</a> <a href="/tag/best-practicies" class="set-1">Best Practicies</a> <a href="/tag/blog" class="set-1">Blog</a> <a href="/tag/connascence" class="set-1">Connascence</a> <a href="/tag/db" class="set-2">DB</a> <a href="/tag/ddd" class="set-1">DDD</a> <a href="/tag/dropdown" class="set-1">DropDown</a> <a href="/tag/entityframework" class="set-1">EntityFramework</a> <a href="/tag/git" class="set-1">Git</a> <a href="/tag/headjs" class="set-1">HeadJS</a> <a href="/tag/holly-war" class="set-1">Holly War</a> <a href="/tag/javasript" class="set-1">JavaSript</a> <a href="/tag/orm" class="set-1">ORM</a> <a href="/tag/oracle" class="set-1">Oracle</a> <a href="/tag/phpunit" class="set-1">PHPUnit</a> <a href="/tag/performance" class="set-1">Performance</a> <a href="/tag/postgresql" class="set-1">PostgreSQL</a> <a href="/tag/principles" class="set-1">Principles</a> <a href="/tag/requirejs" class="set-1">RequireJS</a> <a href="/tag/resources" class="set-1">Resources</a> <a href="/tag/seo" class="set-1">SEO</a> <a href="/tag/sockets" class="set-1">Sockets</a> <a href="/tag/software-design-metrics" class="set-1">Software Design Metrics</a> <a href="/tag/subversion" class="set-1">Subversion</a> <a href="/tag/tree-like-structures" class="set-1">Tree-like structures</a> <a href="/tag/version-control" class="set-1">Version Control</a> <a href="/tag/asp-dot-net" class="set-2">asp.net</a> <a href="/tag/asp-dot-net-mvc" class="set-5">asp.net mvc</a> <a href="/tag/bootstrapping" class="set-1">bootstrapping</a> <a href="/tag/business-rules" class="set-1">business rules</a> <a href="/tag/datepicker" class="set-1">datepicker</a> <a href="/tag/dotnetconf" class="set-1">dotnetconf</a> <a href="/tag/google-sitemap" class="set-1">google sitemap</a> <a href="/tag/jquery-ui" class="set-1">jquery-ui</a> <a href="/tag/lambda-expression" class="set-1">lambda expression</a> <a href="/tag/linq" class="set-1">linq</a> <a href="/tag/llblgen" class="set-1">llblgen</a> <a href="/tag/msil" class="set-1">msil</a> <a href="/tag/mvc" class="set-1">mvc</a> <a href="/tag/mvcextensions" class="set-4">mvcextensions</a> <a href="/tag/network" class="set-1">network</a> <a href="/tag/nhibernate" class="set-3">nhibernate</a> <a href="/tag/phalanger" class="set-1">phalanger</a> <a href="/tag/php" class="set-1">php</a> <a href="/tag/questions" class="set-1">questions</a> <a href="/tag/reflection" class="set-1">reflection</a> <a href="/tag/silverlight" class="set-1">silverlight</a> <a href="/tag/sitemap-dot-xml" class="set-1">sitemap.xml</a> <a href="/tag/xunit" class="set-1">xUnit</a> <a href="/tag/asinkhronnyi-vvod-vyvod" class="set-1">Асинхронный ввод-вывод</a> <a href="/tag/voprosy" class="set-2">Вопросы</a> <a href="/tag/razrabotka" class="set-1">Разработка</a> <a href="/tag/khranimyie-protsiedury" class="set-1">Хранимые процедуры</a> <a href="/tag/dlia-siebia" class="set-1">для себя</a> <a href="/tag/poiskovaia-optimizatsiia" class="set-1">поисковая оптимизация</a>
    </div>
    <div class="sidebar-about">

      <h1>
        <a href="/" rel="home">Hazzik's blog</a>
      </h1>
      <p class="lead">
        <a href="/" rel="home"></a>
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item active">
        <a href="/" rel="home">Главная</a>
      </li>

      

      
      
            <li class="sidebar-nav-item">
              <a href="/about/">Обо мне</a>
            </li>
      
    </ul>
    <ul class="sidebar-social">
      <li class="sidebar-social-item"><a href="http://twitter.com/hazzik" rel="me"><i class="fa fa-twitter"></i></a></li>
      &middot;
      <li class="sidebar-social-item"><a href="http://github.com/hazzik" rel="me"><i class="fa fa-github"></i></a></li>
      &middot;
      <li class="sidebar-social-item"><a href="http://linkedin.com/in/hazzik" rel="me"><i class="fa fa-linkedin"></i></a></li>
    </ul>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://github.com/hazzik/blog.hazzik.ru/edit/master/_posts/tumblr/2012-04-02-mvcextensions-solving-drop-down-lists-problem.md"><i class="fa fa-edit"></i></a>
      <a href="/2012/04/02/mvcextensions-solving-drop-down-lists-problem/">
        MvcExtensions - решение проблемы DropDown Lists
      </a>
    </h1>
    <ul class="post-info">
      <li><i class="fa fa-calendar"></i> <time datetime="2012-04-02T07:30:00+12:00"> 02 Apr 2012 </time></li>
      <li><i class="fa fa-tags"></i> <a href="/tag/mvcextensions" rel="tag">MvcExtensions</a>, <a href="/tag/asp-dot-net-mvc" rel="tag">ASP.NET MVC</a>, <a href="/tag/dropdown" rel="tag">DropDown</a> </li>
      <li><i class="fa fa-comments"></i> <a href="/2012/04/02/mvcextensions-solving-drop-down-lists-problem/#disqus_thread" data-disqus-identifier="/2012/04/02/mvcextensions-solving-drop-down-lists-problem/">0 комментариев</a></li>
    </ul>
    <p>С самого выхода еще первой версии <a href="http://www.asp.net/mvc">ASP.NET MVC</a> три года назад я столкнулся с проблемой выпадающих списков. Наверное <a href="http://habrahabr.ru/post/106370/">каждый</a> <a href="http://pashapash.com/2010/12/dropdown-v-asp-net-mvc-chast-1/">из вас</a> <a href="http://www.google.ru/webhp#q=asp.net+mvc+dropdownlist">задавал себе вопрос</a>: &#8220;Как корректно передавать данные для отображения в выпадающие списки?&#8221; Вот и меня до недавнего времени этот вопрос волновал и очень существенно. Я буквально не мог спать;)</p>

<!-- more -->

<p>Допустим у нас есть форма, для создания фильма. И нам нужно из DropDown выбрать жанр фильма. Откровенно &#8220;профанские&#8221; решения, такие как получение возможных значений прямо на View я рассматривать не буду.</p>

<h2>Решение &#8220;в лоб&#8221;</h2>

<p>Программисты, сталкивающиеся с этой проблемой очень часто идут решать ее в лоб: в модели создается дополнительное свойство Genres типа SelectList и оно заполняется в методе контроллера.</p>

<p>Модель:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Movie</span> <span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">GenreId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">SelectList</span> <span class="n">Genres</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>    
    <span class="c1">//...
</span><span class="p">}</span> 
</code></pre></div>
<p>Контроллер:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MoviesController</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Movie</span><span class="p">()</span> <span class="p">{</span> <span class="n">Genres</span> <span class="p">=</span> <span class="nf">GetAllGenresFromDatabase</span><span class="p">();</span> <span class="p">}</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Movie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="nf">GetMovieFromDatabase</span><span class="p">();</span>
        <span class="n">model</span><span class="p">.</span><span class="n">Genres</span> <span class="p">=</span> <span class="nf">GetAllGenresFromDatabase</span><span class="p">();</span> 
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">EditMovie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>
    <span class="c1">//...
</span><span class="p">}</span>
</code></pre></div>
<p>Но у этого решения для меня есть огромные недостатки:</p>

<ol>
<li> Лишнее поле в модели</li>
<li> Необходимо создавать модель при отображении формы создания</li>
<li> Дублирование кода заполнения возможных значений. <small>Эта проблема становится особенно актуальное, если у вас в системе можно во многих местах выбирать значения из одного и того же справочника.</small></li>
<li> Нет возможности использовать <code>Html.EditorForModel()</code> - ASP.NET отображает общую разметку для всех полей модели, при этом при отображении какого-либо поля модели нет доступа к другим полям.</li>
</ol>

<h2>Решение с использованием ViewBag / ViewData</h2>

<p>Это решение по большей части аналогично предыдущему решению, за тем лишь исключением, что возможные значение передаются через ViewBag:</p>

<p>Модель:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Movie</span> <span class="p">{</span>
    <span class="p">[</span><span class="nf">UIHint</span><span class="p">(</span><span class="s">"Genres"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">GenreId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="c1">//...
</span><span class="p">}</span>
</code></pre></div>
<p>Контроллер:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MoviesController</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">ViewBag</span><span class="p">.</span><span class="n">Genres</span> <span class="p">=</span> <span class="nf">GetAllGenresFromDatabase</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">();</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Movie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="nf">GetMovieFromDatabase</span><span class="p">();</span>
        <span class="n">ViewBag</span><span class="p">.</span><span class="n">Genres</span> <span class="p">=</span> <span class="nf">GetAllGenresFromDatabase</span><span class="p">();</span> 
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">EditMovie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>
    <span class="c1">//...
</span><span class="p">}</span>
</code></pre></div>
<p>Плюсы, по сравнению с предыдущим решением.</p>

<ol>
<li> Нет лишних полей в модели</li>
<li> Нет необходимости создавать модель при отображении формы создания</li>
<li> Можно использовать <code>Html.EditorForModel()</code> в связке с шаблоном (EditorTemplate). При этом для каждого справочника необходим свой шаблон</li>
</ol>

<p>Минусы</p>

<ol>
<li> Используется dynamic или magic-strings*, что не всегда положительно сказывается на возможности рефакторинга</li>
<li> Дублирование кода заполнения возможных значений</li>
<li> Необходимо иметь по шаблону на каждый тип справочника</li>
</ol>

<p>Недостатки</p>

<h3>Улучшенное решение с использованием ViewBag / ViewData</h3>

<p>Для устранения дублировани кода получения возможных значений вынесем этот код в отдельный ActionFilter.</p>

<p>Модель:</p>

<p>та же, что в предыдущем примере</p>

<p>ActionFilter:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">PopulateGenresAttribute</span><span class="p">:</span> <span class="n">ActionFilterAttribute</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnActionExecuted</span><span class="p">(</span><span class="n">ActionExecutedContext</span> <span class="n">filterContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">filterContext</span><span class="p">.</span><span class="n">Controller</span><span class="p">.</span><span class="n">ViewData</span><span class="p">[</span><span class="s">"Genres"</span><span class="p">]</span> <span class="p">=</span> <span class="nf">GetAllGenresFromDatabase</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//...
</span><span class="p">}</span>    
</code></pre></div>
<p>Контроллер:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MoviesController</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">HttpGet</span><span class="p">,</span> <span class="n">PopulateGenres</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">();</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Movie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpGet</span><span class="p">,</span> <span class="n">PopulateGenres</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="nf">GetMovieFromDatabase</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">EditMovie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>
    <span class="c1">//...
</span><span class="p">}</span>
</code></pre></div>
<p>Плюсы, по сравнению с предыдущим решением.</p>

<ol>
<li> Устранено дублирование кода заполнения возможных значений</li>
</ol>

<p>Минусы</p>

<ol>
<li> Используется dynamic или magic-strings*, что не всегда положительно сказывается на возможности рефакторинга</li>
<li> Необходимо иметь по шаблону на каждый тип справочника</li>
</ol>

<h3>Улучшенное решение с использованием ViewBag / ViewData + <a href="http://mvcextensions.codeplex.com">MvcExtnsions</a></h3>

<p>В MvcExensions есть замечательные <a href="http://github.com/MvcExtensions/Core/blob/master/src/MvcExtensions/ModelMetadata/HtmlSelectModelMetadataItemBuilderExtensions.cs">методы для работы с drop-down list</a>: AsDropDownList / AsListBox (первый для выпадающего списка, второй для множественного выбора). Это методы-расширения для конструктора метаданных. Данные методы устанавливают шаблон и позволяют передать в шаблон название поля ViewBag, которое хранит данные с возможными значениями. Таким образом решается проблема с необходимостю иметь по шаблону на каждый справочник.</p>

<p>Модель:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Movie</span> <span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">GenreId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div>
<p>Метаданные:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MovieMetadata</span> <span class="p">:</span> <span class="n">ModelMetadataConfiguration</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">MovieMetadata</span> <span class="p">{</span>
        <span class="nf">Configure</span><span class="p">(</span><span class="n">movie</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">movie</span><span class="p">.</span><span class="n">GenreId</span><span class="p">).</span><span class="nf">AsDropDownList</span><span class="p">(</span><span class="s">"Genres"</span><span class="cm">/*шаблон*/</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Контроллер:</p>

<p>как в предыдущем примере.</p>

<p>Плюсы, по сравнению с предыдущим решением:</p>

<ol>
<li> Используется два универсальных шаблона (DropDownList / ListBox) для всех списков (есть возможность указать свой шаблон, если это необходимо)</li>
</ol>

<p>Минусы:</p>

<ol>
<li> Используется dynamic или magic-strings*, что не всегда положительно сказывается на возможности рефакторинга.</li>
</ol>

<h3>Решение с использованием ChildAction</h3>

<p>Если попытаться использовать child action &#8220;в лоб&#8221;, то это решение просто-напросто не будет работать: не будет работать клиенская валидация, не будут работать сценарии в случае сложных вложенных форм и т.д. В <a href="http://pashapash.com/2010/12/dropdown-v-asp-net-mvc-chast-1/">статье</a> (<a href="http://pashapash.com/2011/01/dropdown-v-asp-net-mvc-chast-2/">часть 2</a>) неизвестного автора (быстрый поиск выдал только <a href="http://habrahabr.ru/users/PashaPash/">профиль</a> на хабре) решены эти проблемы, и по-этому я буду рассматривать <em>окончательное решение автора</em>.</p>

<p>Модель</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Movie</span> <span class="p">{</span>
    <span class="p">[</span><span class="nf">UIHint</span><span class="p">(</span><span class="s">"Genres"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">GenreId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div>
<p>Контроллеры:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MoviesController</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">();</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Movie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="nf">GetMovieFromDatabase</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">EditMovie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GenresController</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">List</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">int</span><span class="p">?</span> <span class="n">selectedGenreId</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">ControllerContext</span><span class="p">.</span><span class="n">ParentActionViewContext</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span> <span class="k">as</span> <span class="kt">int</span><span class="p">?;</span>

        <span class="n">var</span> <span class="n">genres</span> <span class="p">=</span> <span class="nf">GetGenresFormDatabase</span><span class="p">();</span>

        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SelectList</span><span class="p">(</span><span class="n">genres</span><span class="p">,</span> <span class="s">"Id"</span><span class="p">,</span> <span class="s">"DisplayName"</span><span class="p">,</span> <span class="n">selectedGenreId</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span> <span class="p">=</span> <span class="n">model</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">ModelMetadata</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">ControllerContext</span><span class="p">.</span><span class="n">ParentActionViewContext</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">ModelMetadata</span><span class="p">;</span>

        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="s">"DropDown"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Плюсы, по сравнению, с решениями с ViewBag / ViewData</p>

<ol>
<li> Не используется dynamic или magic-strings</li>
<li> Устранено дублирование кода заполнения возможных значений</li>
</ol>

<p>Минусы</p>

<ol>
<li> Дублирование обслуживающего кода</li>
<li> Необходимо иметь по шаблону на каждый тип справочника</li>
<li> Не поддерживается сценарий Post-Redirect-Get</li>
</ol>

<h3>Решение с использованием ChildAction + MvcExtensions</h3>

<p>Я решил, усовершенствовать последнее решение и применить опыт использования ActionFilter, и теперь, с версии <a href="http://nuget.org/packages/MvcExtensions">2.5.0-rc8000 в MvcExtensions</a> поддерживаются выпадающие списки &#8220;из коробки&#8221;. Были добавлены методы расширения, позволяющие указывать, что для отображения данного поля модели необходимо вызвать ChildAction. Также был добавлен <code>SelectListActionAttribute</code>, который занимается обслуживанием метода, предоставлюящего возможнные значения для выпадающего списка. Поддерживается Post-Redirect-Get</p>

<p>Модель:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Movie</span> <span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">GenreId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Метаданные:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MovieMetadata</span> <span class="p">:</span> <span class="n">ModelMetadataConfiguration</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">MovieMetadata</span> <span class="p">{</span>
        <span class="nf">Configure</span><span class="p">(</span><span class="n">movie</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">movie</span><span class="p">.</span><span class="n">GenreId</span><span class="p">).</span><span class="nf">RenderAction</span><span class="p">(</span><span class="s">"List"</span><span class="p">,</span> <span class="s">"Genres"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Контроллеры:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MoviesController</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">();</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Movie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="nf">GetMovieFromDatabase</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">EditMovie</span> <span class="n">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do something with movie.
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GenresController</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">ChildActionOnly</span><span class="p">,</span> <span class="n">SelectListAction</span><span class="p">]</span> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">List</span><span class="p">(</span><span class="kt">int</span> <span class="n">selected</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">model</span> <span class="p">=</span> <span class="nf">GetGenresFormDatabase</span><span class="p">(</span><span class="n">selected</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="s">"DropDown"</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Плюсы, по сравнению с предыдущими решениями</p>

<ol>
<li> Устранено дублирование обслужвающего кода</li>
<li> Используется единый шаблон</li>
<li> MultiSelect &#8220;из коробки&#8221;</li>
<li> Поддерживается сценарий Post-Redirect-Get</li>
</ol>

<h1>Вместо заключения.</h1>

<p>Для меня, как одного из разработчиков MvcExtensions варианты с использованием этой библиотеки предпочтительнее.</p>

<p>Пример кода для варианта с ViewBag / ViewData + MvcExtensions здесь: <a href="http://github.com/MvcExtensions/Core/tree/master/samples">http://github.com/MvcExtensions/Core/tree/master/samples</a></p>

<p>Пример кода для варианта с ChildAction + MvcExtensions здесь: <a href="http://github.com/hazzik/DropDowns">http://github.com/hazzik/DropDowns</a></p>

<hr>

<p>*magic-strings легко побеждаются, использованием констант, и по-этому для меня в данном контексте предпочтительней, чем dynamic</p>

<p>PS: Возможности MvcExtensions для расширения старого доброго ASP.NET MVC просто безграничны.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://github.com/hazzik/blog.hazzik.ru/edit/master/_posts/tumblr/2012-03-18-share-or-individual-developer-database.html"><i class="fa fa-edit"></i></a>
      <a href="/2012/03/18/share-or-individual-developer-database/">
        Общая или личная база данных при разработке?
      </a>
    </h1>
    <ul class="post-info">
      <li><i class="fa fa-calendar"></i> <time datetime="2012-03-18T22:56:00+12:00"> 18 Mar 2012 </time></li>
      <li><i class="fa fa-tags"></i> <a href="/tag/db" rel="tag">DB</a>, <a href="/tag/voprosy" rel="tag">Вопросы</a> </li>
      <li><i class="fa fa-comments"></i> <a href="/2012/03/18/share-or-individual-developer-database/#disqus_thread" data-disqus-identifier="/2012/03/18/share-or-individual-developer-database/">0 комментариев</a></li>
    </ul>
    <p>В этой статье я хочу рассказать о практиках работы разработчиков с базами данных в момент разработки продукта. Все из этих практик были опробованны мной <em>лично</em> и текст здесь основан на моем <em>личном</em> опыте.</p>

<p>Можно использовать единую для всех и индивидуальную базу данных для каждого разработчика. Оба подхода имеют как достоинства, так и недостатки.</p>

<!-- more -->

<h4>Общая база данных.</h4>

<p>Обычно разработчик, изменивший схему БД, кричит на весь офис: &#8220;обновитесь, я изменил базу!&#8221;</p>

<p>При этом подходе изменение в базе <strong>сразу же</strong> отображаются у всех разработчиков, это является как достоинством, так и недостатком.</p>

<p>Если ваша ORM или система для управления схемой базы данных использует бинарный формат для хранения своего проекта, то вам необходимо соблюдать осторожность: необходимо предупредить всех, что вы собираетесь обновить схему данных, ждать своей очереди на обновление схемы, что на начальном этапе разработки, когда схема данных еще не устоялась может существенно замедлить разработку.</p>

<p>Также очень часто разработка может остановиться, если вы уже <em>значительно</em> изменили базу данных, но еще не можете закоммитить изменения, т.к. код который работает с ней еще не написан.</p>

<p>У всех пользователей будет использоваться единая строка подключения к базе, и, в связи с этим, продуктовая боевая база будет называться, <em>скорее всего</em>, так же.</p>

<p>Всем разработчикам нет необходимости думать о том, как обновлять базу данных. С одной стороны это достоинство, но с другой очень часто и недостаток - в команде нет общего видения, какие шаги необходимо предпринять для обновления боевой базы и очень часто боевая и база разработчиков находятся в <em>разном состоянии</em>.</p>

<p>В моей практике очень часто случались ситуации &#8220;ой забыл&#8221;:</p>

<ul><li>"поигрался" с базой данных и не откатил свои изменения;</li>
<li>забыл закоммитить скрипт обновелния в репозиторий; </li>
<li>закоммитил не тот, который выполнял на самом деле; </li>
<li>из-за гонок скрипт просто не выполняется на живой базе.</li>
</ul><p>На одном из предыдущих мест работы для борьбы с такой забывчивостью и несоответсвием баз применялся подход ежедневного реплицирования боевой базы данных на базу данных разработчиков. Т.е. утром человек приходил и выполнял все свои скрипты. Этот подход работает, но очень утомителен.</p>

<h4>Применимость</h4>

<p>Данный подход хорошо подходит для использования вместе с централизованными хранилищами исходного кода, такими как <a href="http://subversion.tigris.org/">SVN</a> или <a href="http://msdn.microsoft.com/en-us/vstudio/ff637362">TFS</a>, если все разработчики работают в одной ветке.</p>

<p>Если все находятся в одном офисе в приделах видимости и слышимости остальных членов команды. Либо разработчики разрабатывают разные модули системы, которые общаются с разными частями базы и никогда не пересекаются (что очень маловероятно). Либо если разработчик на проекте один.</p>

<p>Также такое решение применяется, если база данных очень требовательна к ресурсам или сложна в администрировании (например <a href="http://www.oracle.com/us/products/database/index.html">Oracle</a><em>), либо взимается дополнительная плата за каждый копию (<a href="http://www.microsoft.com/sqlserver">MS SQL Server</a></em>*).</p>

<p>*конечно существует Oracle XE, но в силу своих ограничений его поведение и возможности <em>значительно</em> отличаются от старшего брата.</p>

<p>**для MS SQL Server в версии Express Edition в основном отличия только на размер базы и количество процессорных ядер, а ядро системы такое же как и у старшего брата.</p>

<h4>Индивидуальная база данных для каждого разработчика.</h4>

<p>При этом подходе изменения в базе появляются у разработчика только тогда, когда он забирает изменения из вышестоящего репозитория. Обновление базы возможно как ручное, так и автоматическое.</p>

<p>Сначала, когда мы обдумывали, переход на индивидуальную базу для каждого, тот факт, что каждому необходимо самому заботится о своей базе, казался нам большой проблемой. Но после некоторого времени использования, мы осознали, что проблема была преувеличена.</p>

<p>Данный подход позволяет спокойно менять схему базы, не опасаясь что у кого-то возникнут проблемы в процессе разработке из-за этих изменений.</p>

<p>Данный подход способствует распространению знаний между членами команды о том, как необходимо обновлять базу - в итоге, каждый разработчик мог самостоятельно развернуть проект на боевом сервере.</p>

<p>Данный подход уменьшает количество интеграционных ошибок за счет частого интегрирования изменений.</p>

<p>При использовании данного подхода необходимо следить за версией базы данных - разработчик должен понимать какие скрипты уже выполнены, а какие нет.</p>

<p>Так же необходимо <em>максимально автоматизировать</em> процесс обновления базы, чтобы у разработчика это не отнимало драгоценное время. В конечном итоге такая автоматизация проекту пойдет только на пользу: обновление боевой версии продукта будет также автоматизированно.</p>

<h5>Применимость</h5>

<p>Данный подход идеален для варианта, работы с использованием децентрализованных систем контроля версия (<a href="http://git-scm.com/">Git</a>, <a href="http://mercurial.selenic.com/">Mercurial</a>, <a href="http://bazaar.canonical.com">Bazaar</a>). Либо для централизованных систем контроля версий, при активном использовании веток. Также идеально подходит для распределенных команд.</p>

<h4>Заключение</h4>

<p>В моем случае подход эволюционировал так:</p>

<ol><li><p>Общая база данных (MS SQL), <a href="http://jedivcs.sourceforge.net/">Jedi VCS</a>, модульная разработка, индивидуальные миграционные скрипты, написанные вручную (MySuperModule.sql), каждый разработчик свой модуль заливает на боевой сервер сам.</p></li>
<li><p>Общая база данных (Oracle), SVN, генерация модели данных по схеме БД (<a href="http://www.llblgen.com/">LLBLGen Pro</a>), общий миграционный скрипт на версию (v1.0.1.sql, v1.0.2.sql).</p></li>
<li><p>Общая база данных (Оracle), mercurial, генерация схемы БД по модели (<a href="http://nhforge.org/">NHibernate</a>), общий миграционный скрипт на версию.</p></li>
<li><p>Индивидуальная база данных (MS SQL Server), mercurial, генерация схемы БД по модели (NHibernate), общий миграционный скрипт на версию.</p></li>
<li><p>Индивидуальная база данных (MS SQL Server), mercurial/git, генерация схемы БД и вставка начальных значений через механизм миграций (<a href="https://github.com/schambers/fluentmigrator">FluentMigrator</a>). Обновление через запуск файла <code>migrate.bat</code>, что в принципе может вызываться автоматически через post update hook.</p></li>
</ol><p>Я рекомендую всем пользоваться только подходом c индивидуальной базой данных для разработчика, т.к. для меня его плюсы значительно существенней, чем недостатки.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://github.com/hazzik/blog.hazzik.ru/edit/master/_posts/tumblr/2012-03-18-orm-vs-stored-procedures.html"><i class="fa fa-edit"></i></a>
      <a href="/2012/03/18/orm-vs-stored-procedures/">
        ORM vs. Хранимые процедуры
      </a>
    </h1>
    <ul class="post-info">
      <li><i class="fa fa-calendar"></i> <time datetime="2012-03-18T06:26:00+12:00"> 18 Mar 2012 </time></li>
      <li><i class="fa fa-tags"></i> <a href="/tag/orm" rel="tag">ORM</a>, <a href="/tag/khranimyie-protsiedury" rel="tag">Хранимые процедуры</a>, <a href="/tag/nhibernate" rel="tag">NHibernate</a>, <a href="/tag/holly-war" rel="tag">Holly War</a> </li>
      <li><i class="fa fa-comments"></i> <a href="/2012/03/18/orm-vs-stored-procedures/#disqus_thread" data-disqus-identifier="/2012/03/18/orm-vs-stored-procedures/">0 комментариев</a></li>
    </ul>
    <p><img src="http://richardtaylor.me/wp-content/uploads/2011/01/jpg_vs_png-280x3001.png" alt="png vs jpeg" style="float:right"/>Мой <a href="http://www.byndyu.ru">коллега</a>, позавчера в очередной раз у себя в блоге <a href="http://blog.byndyu.ru/2012/03/blog-post.html">поднял этот больной вопрос</a>.</p>

<p>Для себя я уже давно определился с тем, какой подход использовать, и в этом посте я хочу рассказать вам почему я выбрал именно этот подход.</p>

<!-- more -->

<h3><a href="http://en.wikipedia.org/wiki/Stored_procedure">Хранимые процедуры</a></h3>

<p>Защитники хранимых процедур приводят в пример два плюса их использования:</p>

<ol><li><p>Хранимые процедуры компилируются и за счет этого исполняются быстрее, чем обычные SQL скрипты (как написанные вручную, так и сгенерированные ORM).</p></li>
<li><p>Если вам необходимо обработать много данных и вернуть мало результатов, то без хранимых процедур вам не обойтись.</p></li>
</ol><p>Я не буду спорить с этими достоинствами, т.к. я с ними полностью согласен.</p>

<p>Но практически все защитники подхода с хранимыми процедурами молчат о недостатках:</p>

<ol><li><p><a href="http://en.wikipedia.org/wiki/RDBMS">RDBMS</a> не выполняют контроль целостности кода хранимой процедуры при изменении схемы данных, от которых хранимая процедура зависит.</p>

<p>О том, что моя хранимая процедура сломалась я смогу узнать только при попытке ее выполнить. Но что, если уже поздно и версия попала к пользователям? Я думаю пользователи будут разочарованы.</p>

<p>Чтобы не быть голословным приведу пример (<a href="http://www.microsoft.com/sqlserver">MS SQL Server</a>):</p>

<ol><li><p>тестовый скрипт. <script src="https://gist.github.com/2061572.js?file=gistfile1.sql"></script></p></li>
<li><p>вывод в консоль. <script src="https://gist.github.com/2061572.js?file=output.txt"></script></p></li>
</ol><p>Обратите внимание, что процедура <code>sp_rename</code> только предупреждает, что что-то может сломаться, но не говорит что именно. А если я просто вручную удалю колонку? Я об этом никогда не узнаю.</p>

<p>Таким образом при использовании хранимых процедур мне необходимо держать в голове все зависимости между всеми объектами в базе данных и как можно быстрее распространять и актуализировать эти знания между членами команды, включая новобранцев. У последних, IMO, голова просто лопнет от переизбытка информации.</p></li>
<li><p>Хранимые процедуры отделены от клиентского кода, который их вызывает.</p>

<p>Если хранимая процедура была удалена, или переименована, или просто изменились её параметры об ошибках я узнаю только в момент попытки ее выполнения. Обычно хранимые процедуры используются в качестве средства устранения дублирования кода и, как следствие, вызываются разными клиентами. Т.е. в дополнение ко всем связям между объектами мне необходимо держать в голове информацию о всех клиентах и всех хранимых процедурах, которых они вызывают. В общем случае это ведет к тем же последствиям, что и в пункте 1.</p>

<p>Для того, чтобы посмотреть как ведет себя хранимая процедура, ее код, найти подходящую процедуру и т.п. мне необходимо открыть IDE для моей любимой RDBMS. Т.е. переключить контекст своего внимания. Иногда, когда я таким образом отвлекаюсь я очень долго не могу вернуться к работе.</p></li>
<li><p>Хранимые процедуры не переносимы между различными типами RDBMS.</p>

<p>Вы конечно можете сказать, что это чушь и, от части, будете правы, но только в том случае если вы делает корпоративный или уникальный продукт под заказ.</p>

<p>Но, очень часто продуктовые компании, разрабатывающие коробочные или близкие к ним кастомизируемые тиражируемые решения, попадают в зависимость от требования клиента: &#8220;Ваш продукт хорош, но он использует <a href="http://www.oracle.com/us/products/database/index.html">Oracle</a>, а мы используем MS SQL и хотелось бы&#8230;.&#8221; В этом случае есть 2,5 возможных развития сюжета: вы говорите, что это не возможно и теряете клиента; вы говорите, что нужно подождать полгода (год, два, &#8230;) и клиент уходит; или остается и вы судорожно начинаете искать специалиста по MS SQL, переписывать ваши хранимые процедуры и так далее.</p>

<p>При последнем, самом оптимистичном варианте, вам нужно найти <em>дополнительных</em> людей, иначе вы просто не сможете развивать уже существующую систему. При этом вам будет необходимо как-то достигать согласованности работы обоих систем. Я знаю команды, которые для этого написали <strong>свой</strong> SQL-подобный язык и транслятор к нему в поддерживаемые системы.</p></li>
</ol><h4><a href="http://en.wikipedia.org/wiki/Object-Relational_Mapping">ORM</a></h4>

<p>"Минусы" ORM:</p>

<ol><li><p>ORM не всегда генерирует оптимальные запросы.
Да, это так. Но, большинство современных ORM предоставляют пользователям возможность переключиться на уровень ближе к базе данных, вплоть до написания запросов на SQL и использования хранимых процедур.</p>

<p>К примеру <a href="http://nhforge.org">NHibernate</a>, которую я считаю лучшей, предоставляет следующие возможности для написания запросов:</p>

<ol><li><a href="http://en.wikipedia.org/wiki/LINQ">LINQ</a> - самый высокоуровневый объектный подход к написанию запросов.</li>
<li><a href="http://nhforge.org/doc/nh/en/index.html#querycriteria">CriteriaAPI</a> или <a href="http://nhforge.org/doc/nh/en/index.html#queryqueryover">QueryOver</a> - объектный, но SQL-ориентированный подход.</li>
<li><a href="http://nhforge.org/doc/nh/en/index.html#queryhql">HQL</a> - hibernate query language - SQL-подобный язык для написания запросов.</li>
<li><a href="http://nhforge.org/doc/nh/en/index.html#querysql">SQL</a> - &#8220;голый&#8221; SQL</li>
<li><a href="http://nhforge.org/doc/nh/en/index.html#sp_query">Хранимые процедуры</a>.</li>
</ol><p>Также могу сказать, что кривость и неоптимальность запроса почти всегда напрямую зависит от кривости рук разработчика.</p></li>
<li><p>ORM тратит время на трансляцию запросов в SQL
Да, но: это время не такое уж и большое; большинство ORM транслирует запрос в SQL только при первом выполнении запроса, затем они его кэшируют.</p></li>
<li><p>ORM - большие страшные монстры, для маленьких проектов, как &#8220;из пушки по воробьям&#8221;</p>

<p>На это могу возразить то, что существует множество мелких ORM. Так же можно использовать ORM напрямую и не заботится ни о каких DDD и прочих монструозных технологиях. К примеру, использование NHibernate + <a href="http://fluentnhibernate.org/">FluentNHibernate</a> (<a href="http://wiki.fluentnhibernate.org/Auto_mapping">автомаппинг</a>) требует от разработчика написания 2х классов: 1. Конифигурацию NH; 2. Конфигурацию автомапинга. Причем эти классы могут быть практически без изменения кочевать из проекта в проект.</p></li>
</ol><p>Плюсы ORM для меня (в порядке появления в голове):</p>

<ol><li><p>ORM обеспечивает контроль целостности схемы данных</p></li>
<li><p>ОРМ позволяет работать с данными как с объектами. При этом обеспечивается контроль типов.</p></li>
<li><p>Некоторые ORM (EF, LLBLGen Pro) позволяют генерировать строго-типизированные обвертки, для вызова хранимых процедур.</p></li>
<li><p>Мне не нужно писать никакого кода на страшном ADO.NET.</p></li>
<li><p>Большинство ORM поддерживает несколько типов баз данных.</p></li>
</ol><p>Применительно к NHibernate:</p>

<ol><li><p>NHibernate поддерживает <a href="http://ayende.com/blog/1686/batching-support-in-nhibernate">группировку запросов в пакеты</a> и таким образом уменьшается количество обращений к RDBMS</p></li>
<li><p>NHibernate поддерживает <a href="http://ayende.com/blog/3979/nhibernate-futures">отложенные запросы</a>, которые выполнятся только в момент первого обращения к результатам. При этом все отложенные невыполненные запросы выполнятся в одном пакете.</p></li>
<li><p><a href="http://nhibernate.hibernatingrhinos.com/28/first-and-second-level-caching-in-nhibernate">Second Level Cache</a> - очень мощный инструмент. В умелых руках, повышает производительность приложения в разы.</p></li>
</ol><h4>Заключение</h4>

<p>ORM это не инструмент для замены хранимых процедур и запросов, это инструмент, для их дополнения. Он позволяет писать меньше рутинного однообразного кода - он уже написан за вас. Этот код <em>уже</em> протестирован множеством разработчиков на различных типах проектов. от мельчайших до сверх-гигантских.</p>

<p>Если в вашем проекте требуется мощь хранимых процедур, или скриптов написанных на SQL, то всегда используйте их <em>вместе</em> с, а не <em>вместо</em> ORM. Также я рекомендую пользоваться хранимыми процедурами только в исключительных ситуациях: только тогда, когда без них не обойтись.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://github.com/hazzik/blog.hazzik.ru/edit/master/_posts/tumblr/2011-10-09-web-requre-client-script-dependency-framework.html"><i class="fa fa-edit"></i></a>
      <a href="/2011/10/09/web-requre-client-script-dependency-framework/">
        Web.Requre - client script dependency framework
      </a>
    </h1>
    <ul class="post-info">
      <li><i class="fa fa-calendar"></i> <time datetime="2011-10-09T21:46:00+12:00"> 09 Oct 2011 </time></li>
      <li><i class="fa fa-tags"></i> <a href="/tag/asp-dot-net-mvc" rel="tag">ASP.NET MVC</a>, <a href="/tag/requirejs" rel="tag">RequireJS</a>, <a href="/tag/headjs" rel="tag">HeadJS</a>, <a href="/tag/javasript" rel="tag">JavaSript</a>, <a href="/tag/resources" rel="tag">Resources</a> </li>
      <li><i class="fa fa-comments"></i> <a href="/2011/10/09/web-requre-client-script-dependency-framework/#disqus_thread" data-disqus-identifier="/2011/10/09/web-requre-client-script-dependency-framework/">0 комментариев</a></li>
    </ul>
    <div dir="ltr" style="text-align: left;" trbidi="on"><div dir="ltr" style="text-align: left;" trbidi="on"><div dir="ltr" style="text-align: left;" trbidi="on"><h1>Что это?</h1><h1><span class="Apple-style-span" style="font-size: small; font-weight: normal;"><i>Web.Require</i> - небольшая библиотечка, для облегчения подключения скриптов в ваше Web-приложение.</span></h1><div><span class="Apple-style-span" style="font-size: small; font-weight: normal;"></span><br/><a name="more"></a></div><h1>Давай примеры!</h1><pre class="brush:html">&lt;head&gt;<br/>    &lt;title&gt;@ViewBag.Title&lt;/title&gt;<br/>    @Html.RequireStyleSheet(<br/>        Url.Content("~/Content/reset.css"),<br/>        Url.Content("~/Content/Site.less"),<br/>        Url.Content("~/Content/themes/base/minified/jquery.ui.all.min.css"))<br/><br/>    @Html.RequireScript(<br/>        Url.Content("~/Scripts/jquery-1.6.4.min.js"), <br/>        Url.Content("~/Scripts/jquery-ui-1.8.16.min.js"))<br/><br/>    @Html.OutputRequiredStyleSheets()<br/>    @Html.OutputRequiredScripts()<br/>&lt;/head&gt;<br/></pre><br/>Что тут происходит? Все очень просто: мы подключаем три css и два js файла. Что нам дает такой подход? Почему просто нельзя подключить скрипты в лоб?<br/><br/>Давайте представим, что какой-то контрол, например ваш кастомный диалог или, datepicker требует для своей работы отдельного скрпта? Как быть?<br/><ul style="text-align: left;"><li>Первый вариант - просто в контроле написать &lt;script src=&#8230;/&gt;. А если этот контрол на странице используется несколько раз?</li></ul><ul style="text-align: left;"><li>Второй вариант - просто включить этот скрипт в &lt;head&gt;. А если этот скрпит очень большой и прожорливый и используется не везде? </li></ul>Все очень просто: с помощью <i>Web.Require</i> совместим оба варианта и решим их проблемы: скрипт подгружается только один раз и только тогда, когда это необходимо. Например:<br/><br/></div><pre class="brush:csharp brush:html">&lt;!--DateTimePicker.cshtml--&gt;<br/>@Html.RequireScript(<br/>    Url.Content("~/Scripts/jquery-1.6.4.min.js"),<br/>    Url.Content("~/Scripts/jquery-ui-1.8.16.min.js"),<br/>    Url.Content("~/Scripts/jquery.ui.datepicker-ru.js"),<br/>    Url.Content("~/Scripts/DateTimePicker.js"))</pre>В итоге DateTimePicker.js добавиться в тэг  и наступит всеобщее счастье;)<br/><br/><h1>Как установить?</h1><div><span class="Apple-style-span" style="background-color: white; color: #333333; font-family: 'Segoe UI', Tahoma, 'Helvetica Neue', Arial, Helvetica, sans-serif; font-size: 12px; line-height: 12px;"></span><br/><div class="commandWrapper" style="background-attachment: initial; background-clip: initial; background-color: initial; background-image: -webkit-gradient(linear, 0 0, 0 100%, from(rgb(214, 214, 214)), to(rgb(80, 80, 80))); background-origin: initial; border-bottom-color: rgb(255, 255, 255); border-bottom-left-radius: 8px 8px; border-bottom-right-radius: 8px 8px; border-bottom-style: solid; border-bottom-width: 0px; border-color: initial; border-left-color: rgb(255, 255, 255); border-left-style: solid; border-left-width: 0px; border-right-color: rgb(255, 255, 255); border-right-style: solid; border-right-width: 0px; border-style: initial; border-top-color: rgb(255, 255, 255); border-top-left-radius: 8px 8px; border-top-right-radius: 8px 8px; border-top-style: solid; border-top-width: 0px; font-family: inherit; font-size: 12px; font-style: inherit; margin-bottom: 36px; margin-left: 0px; margin-right: 0px; margin-top: 36px; outline-color: initial; outline-style: initial; outline-width: 0px; padding-bottom: 4px; padding-left: 4px; padding-right: 4px; padding-top: 4px; vertical-align: baseline;"><div class="commandPrompt" style="-webkit-box-shadow: rgba(0, 0, 0, 0.59375) 6px 6px 14px inset, rgb(102, 102, 102) 1px 1px 4px; background-attachment: initial; background-clip: initial; background-color: initial; background-image: -webkit-gradient(linear, 0 0, 0 100%, from(rgb(94, 94, 94)), to(rgb(0, 0, 0))); background-origin: initial; border-bottom-color: rgb(196, 196, 196); border-bottom-left-radius: 6px 6px; border-bottom-right-radius: 6px 6px; border-bottom-style: solid; border-bottom-width: 1px; border-color: initial; border-left-color: rgb(196, 196, 196); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(196, 196, 196); border-right-style: solid; border-right-width: 1px; border-style: initial; border-top-color: rgb(196, 196, 196); border-top-left-radius: 6px 6px; border-top-right-radius: 6px 6px; border-top-style: solid; border-top-width: 1px; box-shadow: rgba(0, 0, 0, 0.59375) 6px 6px 14px inset, rgb(102, 102, 102) 1px 1px 4px; font-family: inherit; font-size: 12px; font-style: inherit; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; outline-color: initial; outline-style: initial; outline-width: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; text-shadow: rgb(0, 0, 0) 1px 1px 1px; vertical-align: baseline;"><div class="command" style="border-bottom-width: 0px; border-color: initial; border-left-width: 0px; border-right-width: 0px; border-style: initial; border-top-width: 0px; color: #e2e2e2; font-family: Consolas, 'Andale Mono WT', 'Andale Mono', 'Lucida Console', 'Lucida Sans Typewriter', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Liberation Mono', 'Nimbus Mono L', Monaco, 'Courier New', Courier, monospace; font-size: 24px; font-style: inherit; line-height: 24px; margin-bottom: 24px; margin-left: 8px; margin-right: 8px; margin-top: 24px; outline-color: initial; outline-style: initial; outline-width: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; vertical-align: baseline;">PM&gt; Install-Package Web.Require</div><br/><div></div></div></div></div></div><h1>P.S.</h1>В будущем ожидаются следующие фишки:<br/><br/><ul style="text-align: left;"><li>Асинхронное подключение js</li><li>Конкатенация и минификация js и css + кэширование</li></ul><h1>P.P.S.</h1><div>Пример использования можно посмотреть <a href="https://github.com/hazzik/beerconf-website/">здесь</a></div></div><div class="blogger-post-footer"><img width="1" height="1" src="https://blogger.googleusercontent.com/tracker/1624027437398699573-3477034535813804388?l=hazzik.blogspot.com" alt=""/></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://github.com/hazzik/blog.hazzik.ru/edit/master/_posts/tumblr/2011-08-24-mvcextensions-bootstrapping.html"><i class="fa fa-edit"></i></a>
      <a href="/2011/08/24/mvcextensions-bootstrapping/">
        MvcExtensions: bootstrapping
      </a>
    </h1>
    <ul class="post-info">
      <li><i class="fa fa-calendar"></i> <time datetime="2011-08-24T13:52:00+12:00"> 24 Aug 2011 </time></li>
      <li><i class="fa fa-tags"></i> <a href="/tag/asp-dot-net-mvc" rel="tag">asp.net mvc</a>, <a href="/tag/mvcextensions" rel="tag">mvcextensions</a> </li>
      <li><i class="fa fa-comments"></i> <a href="/2011/08/24/mvcextensions-bootstrapping/#disqus_thread" data-disqus-identifier="/2011/08/24/mvcextensions-bootstrapping/">0 комментариев</a></li>
    </ul>
    <p>Как я уже <a href="/2011/08/20/mvcextensions-intro/">писал во введении</a>, весь код, выполняющийся при старте приложения необходимо помещать в, BootstrapperTask.</p>

<h1>Bootstrapper tasks</h1>

<p>В MvcExtensions для размещения кода, выполняющегося при запуске приложения существует понятие <a href="http://en.wikipedia.org/wiki/Bootstrapping_(computing)">Bootstrapper</a>, которому можно назначать задачи.</p>

<!-- more -->

<p>Назначение задачи происходит следующим образом:</p>

<pre><code>//Global.asax.cs
public class MvcApplication : WindsorMvcApplication {
    public MvcApplication() {
        Bootstrapper.BootstrapperTasks
            .Include&lt;RegisterControllers&gt;(); // задача, для регистрации контроллеров в IoC контейнер.
        }
    }
</code></pre>

<p>Кроме стандартной задачи для регистрации контроллеров существует еще несколько стандартных задач, которые подключают дополнительные возможности. Также есть несколько базовых классов, которые позволяют выполняет такие полезные действия, как регистрация маршрутов, фильтров, модел-байндеров, etc.</p>

<h2>Регистрация маршрутов</h2>

<p>Для регистрации маршрутов вам необходимо унаследоваться от абстрактного класса <em>RegisterRoutesBase</em>, и подключить задачу к bootstrapper.</p>

<pre><code>public class RegisterRoutes : RegisterRoutesBase {
    public RegisterRoutes(RouteCollection routes) 
        : base(routes) { }

    protected override void Register() {
        Routes.IgnoreRoute("favicon.ico");
        Routes.IgnoreRoute("{resource}.axd/{*pathInfo}");
        Routes.MapRoute("Default",
            "{controller}/{action}/{id}",
            new { controller = "Home", action = "Index", id = UrlParameter.Optional });
    }
}
</code></pre>

<h2>Конфигурация фильтров</h2>

<p>Еще одной интересной возможностью MvcExtensions является возможность добавлять фильтры (IMvcFilter) к действиям контроллеров динамически. Этот подход позволяет писать фильтры не через атрибуты, а как обычные классы, при этом появляется возможность использовать инжекцию зависимостей через конструктор. Для регистрации фильтров необходимо унаследоваться от базового абстрактного класса <em>ConfigureFiltersBase</em>.</p>

<p>Рассмотрим небольшой пример:</p>

<pre><code>public class ConfigureFilters : ConfigureFiltersBase { 
    public ConfigureFilters(IFilterRegistry registry) 
        : base(registry) { }


    protected override void Configure() {
        Registry.Register&lt;ProductController, PopulateCategories, PopulateSuppliers&gt;(c =&gt; c.Create())
                .Register&lt;ProductController, PopulateCategories, PopulateSuppliers&gt;(c =&gt; c.Edit(0));
    }
}
</code></pre>

<p>Как видно из примера, для контроллера <em>ProductController</em> для действий <em>Create</em> и <em>Edit</em> регистрируются два фильтра <em>PopulateCategories</em> и <em>PopulateSuppliers</em></p>

<h2>Регистрация ModelBinder</h2>

<p>В жизни бывает всякое и иногда необходимо написать свой ModelBinder, с помощью <em>ConfigureModelBindersBase</em> вы можете привязать свой ModelBinder к модели.</p>

<pre><code>public class ConfigureModelBinders : ConfigureModelBindersBase { 
    public ConfigureModelBinders(TypeMappingRegistry&lt;object, IModelBinder&gt; registry)
        : base(registry) { }

    protected override void Configure() {
        Registry.Register&lt;ProductEditModel, ProductEditModelBinder&gt;();
    }
} 
</code></pre>

<p>Здесь вроде все понятно.</p>

<h2>Собственные Bootstrapper tasks</h2>

<p>Нет ничего проще, чем создать собственные задачи: необходимо просто  унаследоваться от базового класса <em>BootstrapperTask</em>. Также задачи могут зависеть от других задач, для этого вашу задачу нужно пометить атрибутом [DependsOn]. И главное: н<em>е забудьте зарегистрировать свои задачи в бутстрапер.</em></p>

<pre><code>[DependsOn(typeof(RegisterRoutes))]
public class ConfigureFiltersBase : BootstrapperTask {
    protected override void Configure() {
        // Ваш код будет здесь
    }
}
</code></pre>

<h1>Вместо заключения</h1>

<p>На сегодня все. В следующей статье я планирую подробно рассмотреть конфигурацию метаданых.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page5">Раньше</a>
  
  
    
      <a class="pagination-item newer" href="/page3">Позднее</a>
    
  
</div>

    </div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'blog-hazzik-ru'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<!-- Yandex.Metrika counter -->
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript"></script>
<script type="text/javascript">
try { var yaCounter13173247 = new Ya.Metrika({id:13173247,
          webvisor:true,
          clickmap:true,
          trackLinks:true,
          accurateTrackBounce:true});
} catch(e) { }
</script>
<noscript><div><img src="//mc.yandex.ru/watch/13173247" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

  </body>
</html>
